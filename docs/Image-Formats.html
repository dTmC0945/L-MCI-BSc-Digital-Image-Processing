<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Code for Digital Image Processing Image Formats</title>
<meta name="author" content="Daniel McGuiness" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" href="config/style.css">
<script type="text/javascript"  src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="config/test.js">
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
// @license-end
</script>

<script>
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
org_html_manager.set("TOC_DEPTH", "3");
org_html_manager.set("LINK_HOME", "");
org_html_manager.set("LINK_UP", "index.html");
org_html_manager.set("LOCAL_TOC", "1");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "underline");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "1");
org_html_manager.set("VIEW", "info");
org_html_manager.setup();  // activate after the parameters are set
// @license-end
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="index.html"> UP </a>
 |
 <a accesskey="H" href=""> HOME </a>
</div><div id="content" class="content">
<h1 class="title">Code for Digital Image Processing Image Formats</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org1172de7">Introduction</a></li>
<li><a href="#org98b6775">Image Compression from Scratch</a></li>
<li><a href="#org94ffe50">JPEG Compression</a></li>
</ul>
</div>
</div>
<p>
These are the code snippets used in <span class="Hlight">Perception</span>
part of <code>Digital Image Processing</code>.
</p>

<div id="outline-container-org1172de7" class="outline-2">
<h2 id="org1172de7">Introduction</h2>
<div class="outline-text-2" id="text-org1172de7">
<p>
The following code uses the standard matplotlib along with the
custom ChalcedonPy which is detailed in its source code here.
</p>

<p>
The code is used primarily in the following code as a means to
save figures for use in slides.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org9c81214"><span class="org-keyword">import</span> matplotlib.pyplot <span class="org-keyword">as</span> plt
<span class="org-keyword">import</span> ChalcedonPy <span class="org-keyword">as</span> cp

<span class="org-comment-delimiter"># </span><span class="org-comment">Initialise ChalcedonPy</span>
cp.init<span class="org-rainbow-delimiters-depth-1">(</span>save_path<span class="org-operator">=</span><span class="org-string">"Image-Formats"</span>,
        display_mode<span class="org-operator">=</span><span class="org-string">"web"</span><span class="org-rainbow-delimiters-depth-1">)</span> 
</pre>
</div>
</div>
</div>


<div id="outline-container-org98b6775" class="outline-2">
<h2 id="org98b6775">Image Compression from Scratch</h2>
<div class="outline-text-2" id="text-org98b6775">
<p>
The following is a code to compress image to JPEG.
</p>

<p>
This code only does the image compression part and not the
decompression part.
</p>

<p>
This code is originally written by <a href="https://github.com/mVirtuoso21/JPEG-Image-Compressor">mVirtuoso21</a> and adapted.
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgf316a5e"><span class="org-keyword">from</span> collections <span class="org-keyword">import</span> Counter

<span class="org-keyword">import</span> numpy <span class="org-keyword">as</span> np

<span class="org-comment-delimiter"># </span><span class="org-comment">A function definition to do the zigzag of the quantised block</span>
<span class="org-keyword">def</span> <span class="org-function-name">zigzag</span><span class="org-rainbow-delimiters-depth-1">(</span>matrix: np.ndarray<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">-&gt;</span> np.ndarray:
    <span class="org-doc">"""</span>
<span class="org-doc">    Computes the zigzag of a quantized block</span>
<span class="org-doc">    :param numpy.ndarray matrix:        quantized matrix</span>
<span class="org-doc">    :returns:                                           zigzag vectors in an array</span>
<span class="org-doc">    """</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">initializing the variables</span>
    <span class="org-variable-name">h</span> <span class="org-operator">=</span> 0
    <span class="org-variable-name">v</span> <span class="org-operator">=</span> 0
    <span class="org-variable-name">v_min</span> <span class="org-operator">=</span> 0
    <span class="org-variable-name">h_min</span> <span class="org-operator">=</span> 0
    <span class="org-variable-name">v_max</span> <span class="org-operator">=</span> matrix.shape<span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span>
    <span class="org-variable-name">h_max</span> <span class="org-operator">=</span> matrix.shape<span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span>
    <span class="org-variable-name">i</span> <span class="org-operator">=</span> 0
    <span class="org-variable-name">output</span> <span class="org-operator">=</span> np.zeros<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>v_max <span class="org-operator">*</span> h_max<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

    <span class="org-keyword">while</span> <span class="org-rainbow-delimiters-depth-1">(</span>v <span class="org-operator">&lt;</span> v_max<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">and</span> <span class="org-rainbow-delimiters-depth-1">(</span>h <span class="org-operator">&lt;</span> h_max<span class="org-rainbow-delimiters-depth-1">)</span>:
        <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>h <span class="org-operator">+</span> v<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-operator">%</span> 2<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">==</span> 0:  <span class="org-comment-delimiter"># </span><span class="org-comment">going up</span>
            <span class="org-keyword">if</span> v <span class="org-operator">==</span> v_min:
                <span class="org-variable-name">output</span><span class="org-rainbow-delimiters-depth-1">[</span>i<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> matrix<span class="org-rainbow-delimiters-depth-1">[</span>v, h<span class="org-rainbow-delimiters-depth-1">]</span>  <span class="org-comment-delimiter"># </span><span class="org-comment">first line</span>
                <span class="org-keyword">if</span> h <span class="org-operator">==</span> h_max:
                    <span class="org-variable-name">v</span> <span class="org-operator">=</span> v <span class="org-operator">+</span> 1
                <span class="org-keyword">else</span>:
                    <span class="org-variable-name">h</span> <span class="org-operator">=</span> h <span class="org-operator">+</span> 1
                <span class="org-variable-name">i</span> <span class="org-operator">=</span> i <span class="org-operator">+</span> 1
            <span class="org-keyword">elif</span> <span class="org-rainbow-delimiters-depth-1">(</span>h <span class="org-operator">==</span> h_max <span class="org-operator">-</span> 1<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">and</span> <span class="org-rainbow-delimiters-depth-1">(</span>v <span class="org-operator">&lt;</span> v_max<span class="org-rainbow-delimiters-depth-1">)</span>:  <span class="org-comment-delimiter"># </span><span class="org-comment">last column</span>
                <span class="org-variable-name">output</span><span class="org-rainbow-delimiters-depth-1">[</span>i<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> matrix<span class="org-rainbow-delimiters-depth-1">[</span>v, h<span class="org-rainbow-delimiters-depth-1">]</span>
                <span class="org-variable-name">v</span> <span class="org-operator">=</span> v <span class="org-operator">+</span> 1
                <span class="org-variable-name">i</span> <span class="org-operator">=</span> i <span class="org-operator">+</span> 1
            <span class="org-keyword">elif</span> <span class="org-rainbow-delimiters-depth-1">(</span>v <span class="org-operator">&gt;</span> v_min<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">and</span> <span class="org-rainbow-delimiters-depth-1">(</span>h <span class="org-operator">&lt;</span> h_max <span class="org-operator">-</span> 1<span class="org-rainbow-delimiters-depth-1">)</span>:  <span class="org-comment-delimiter"># </span><span class="org-comment">all other cases</span>
                <span class="org-variable-name">output</span><span class="org-rainbow-delimiters-depth-1">[</span>i<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> matrix<span class="org-rainbow-delimiters-depth-1">[</span>v, h<span class="org-rainbow-delimiters-depth-1">]</span>
                <span class="org-variable-name">v</span> <span class="org-operator">=</span> v <span class="org-operator">-</span> 1
                <span class="org-variable-name">h</span> <span class="org-operator">=</span> h <span class="org-operator">+</span> 1
                <span class="org-variable-name">i</span> <span class="org-operator">=</span> i <span class="org-operator">+</span> 1
        <span class="org-keyword">else</span>:  <span class="org-comment-delimiter"># </span><span class="org-comment">going down</span>
            <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-1">(</span>v <span class="org-operator">==</span> v_max <span class="org-operator">-</span> 1<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">and</span> <span class="org-rainbow-delimiters-depth-1">(</span>h <span class="org-operator">&lt;=</span> h_max <span class="org-operator">-</span> 1<span class="org-rainbow-delimiters-depth-1">)</span>:  <span class="org-comment-delimiter"># </span><span class="org-comment">last line</span>
                <span class="org-variable-name">output</span><span class="org-rainbow-delimiters-depth-1">[</span>i<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> matrix<span class="org-rainbow-delimiters-depth-1">[</span>v, h<span class="org-rainbow-delimiters-depth-1">]</span>
                <span class="org-variable-name">h</span> <span class="org-operator">=</span> h <span class="org-operator">+</span> 1
                <span class="org-variable-name">i</span> <span class="org-operator">=</span> i <span class="org-operator">+</span> 1
            <span class="org-keyword">elif</span> h <span class="org-operator">==</span> h_min:  <span class="org-comment-delimiter"># </span><span class="org-comment">first column</span>
                <span class="org-variable-name">output</span><span class="org-rainbow-delimiters-depth-1">[</span>i<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> matrix<span class="org-rainbow-delimiters-depth-1">[</span>v, h<span class="org-rainbow-delimiters-depth-1">]</span>
                <span class="org-keyword">if</span> v <span class="org-operator">==</span> v_max <span class="org-operator">-</span> 1:
                    <span class="org-variable-name">h</span> <span class="org-operator">=</span> h <span class="org-operator">+</span> 1
                <span class="org-keyword">else</span>:
                    <span class="org-variable-name">v</span> <span class="org-operator">=</span> v <span class="org-operator">+</span> 1
                <span class="org-variable-name">i</span> <span class="org-operator">=</span> i <span class="org-operator">+</span> 1
            <span class="org-keyword">elif</span> <span class="org-rainbow-delimiters-depth-1">(</span>v <span class="org-operator">&lt;</span> v_max <span class="org-operator">-</span> 1<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">and</span> <span class="org-rainbow-delimiters-depth-1">(</span>h <span class="org-operator">&gt;</span> h_min<span class="org-rainbow-delimiters-depth-1">)</span>:  <span class="org-comment-delimiter"># </span><span class="org-comment">all other cases</span>
                <span class="org-variable-name">output</span><span class="org-rainbow-delimiters-depth-1">[</span>i<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> matrix<span class="org-rainbow-delimiters-depth-1">[</span>v, h<span class="org-rainbow-delimiters-depth-1">]</span>
                <span class="org-variable-name">v</span> <span class="org-operator">=</span> v <span class="org-operator">+</span> 1
                <span class="org-variable-name">h</span> <span class="org-operator">=</span> h <span class="org-operator">-</span> 1
                <span class="org-variable-name">i</span> <span class="org-operator">=</span> i <span class="org-operator">+</span> 1
        <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-1">(</span>v <span class="org-operator">==</span> v_max <span class="org-operator">-</span> 1<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">and</span> <span class="org-rainbow-delimiters-depth-1">(</span>h <span class="org-operator">==</span> h_max <span class="org-operator">-</span> 1<span class="org-rainbow-delimiters-depth-1">)</span>:  <span class="org-comment-delimiter"># </span><span class="org-comment">bottom right element</span>
            <span class="org-variable-name">output</span><span class="org-rainbow-delimiters-depth-1">[</span>i<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> matrix<span class="org-rainbow-delimiters-depth-1">[</span>v, h<span class="org-rainbow-delimiters-depth-1">]</span>
            <span class="org-keyword">break</span>
    <span class="org-keyword">return</span> output


<span class="org-keyword">def</span> <span class="org-function-name">trim</span><span class="org-rainbow-delimiters-depth-1">(</span>array: np.ndarray<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">-&gt;</span> np.ndarray:
    <span class="org-doc">"""</span>
<span class="org-doc">    in case the trim_zeros function returns an empty array, add a zero to the array to use as the DC component</span>
<span class="org-doc">    :param numpy.ndarray array: array to be trimmed</span>
<span class="org-doc">    :return numpy.ndarray:</span>
<span class="org-doc">    """</span>
    <span class="org-variable-name">trimmed</span> <span class="org-operator">=</span> np.trim_zeros<span class="org-rainbow-delimiters-depth-1">(</span>array, <span class="org-string">'b'</span><span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-keyword">if</span> <span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-1">(</span>trimmed<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">==</span> 0:
        <span class="org-variable-name">trimmed</span> <span class="org-operator">=</span> np.zeros<span class="org-rainbow-delimiters-depth-1">(</span>1<span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-keyword">return</span> trimmed


<span class="org-keyword">def</span> <span class="org-function-name">run_length_encoding</span><span class="org-rainbow-delimiters-depth-1">(</span>array: np.ndarray<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">-&gt;</span> <span class="org-builtin">list</span>:
    <span class="org-doc">"""</span>
<span class="org-doc">    finds the intermediary stream representing the zigzags</span>
<span class="org-doc">    format for DC components is &lt;size&gt;&lt;amplitude&gt;</span>
<span class="org-doc">    format for AC components is &lt;run_length, size&gt; &lt;Amplitude of non-zero&gt;</span>
<span class="org-doc">    :param numpy.ndarray array: zigzag vectors in array</span>
<span class="org-doc">    :returns: run length encoded values as an array of tuples</span>
<span class="org-doc">    """</span>
    <span class="org-variable-name">encoded</span> <span class="org-operator">=</span> <span class="org-builtin">list</span><span class="org-rainbow-delimiters-depth-1">()</span>
    <span class="org-variable-name">run_length</span> <span class="org-operator">=</span> 0
    <span class="org-variable-name">eob</span> <span class="org-operator">=</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"EOB"</span>,<span class="org-rainbow-delimiters-depth-1">)</span>

    <span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-2">(</span>array<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>:
        <span class="org-keyword">for</span> j <span class="org-keyword">in</span> <span class="org-builtin">range</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-2">(</span>array<span class="org-rainbow-delimiters-depth-3">[</span>i<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>:
            <span class="org-variable-name">trimmed</span> <span class="org-operator">=</span> trim<span class="org-rainbow-delimiters-depth-1">(</span>array<span class="org-rainbow-delimiters-depth-2">[</span>i<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
            <span class="org-keyword">if</span> j <span class="org-operator">==</span> <span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-1">(</span>trimmed<span class="org-rainbow-delimiters-depth-1">)</span>:
                encoded.append<span class="org-rainbow-delimiters-depth-1">(</span>eob<span class="org-rainbow-delimiters-depth-1">)</span>  <span class="org-comment-delimiter"># </span><span class="org-comment">EOB</span>
                <span class="org-keyword">break</span>
            <span class="org-keyword">if</span> i <span class="org-operator">==</span> 0 <span class="org-keyword">and</span> j <span class="org-operator">==</span> 0:  <span class="org-comment-delimiter"># </span><span class="org-comment">for the first DC component</span>
                encoded.append<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-builtin">int</span><span class="org-rainbow-delimiters-depth-3">(</span>trimmed<span class="org-rainbow-delimiters-depth-4">[</span>j<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>.bit_length<span class="org-rainbow-delimiters-depth-3">()</span>, trimmed<span class="org-rainbow-delimiters-depth-3">[</span>j<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
            <span class="org-keyword">elif</span> j <span class="org-operator">==</span> 0:  <span class="org-comment-delimiter"># </span><span class="org-comment">to compute the difference between DC components</span>
                <span class="org-variable-name">diff</span> <span class="org-operator">=</span> <span class="org-builtin">int</span><span class="org-rainbow-delimiters-depth-1">(</span>array<span class="org-rainbow-delimiters-depth-2">[</span>i<span class="org-rainbow-delimiters-depth-2">][</span>j<span class="org-rainbow-delimiters-depth-2">]</span> <span class="org-operator">-</span> array<span class="org-rainbow-delimiters-depth-2">[</span>i <span class="org-operator">-</span> 1<span class="org-rainbow-delimiters-depth-2">][</span>j<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
                <span class="org-keyword">if</span> diff <span class="org-operator">!=</span> 0:
                    encoded.append<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>diff.bit_length<span class="org-rainbow-delimiters-depth-3">()</span>, diff<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
                <span class="org-keyword">else</span>:
                    encoded.append<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>1, diff<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
                <span class="org-variable-name">run_length</span> <span class="org-operator">=</span> 0
            <span class="org-keyword">elif</span> trimmed<span class="org-rainbow-delimiters-depth-1">[</span>j<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">==</span> 0:  <span class="org-comment-delimiter"># </span><span class="org-comment">increment run_length by one in case of a zero</span>
                <span class="org-variable-name">run_length</span> <span class="org-operator">+=</span> 1
            <span class="org-keyword">else</span>:  <span class="org-comment-delimiter"># </span><span class="org-comment">intermediary steam representation of the AC components</span>
                encoded.append<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>run_length, <span class="org-builtin">int</span><span class="org-rainbow-delimiters-depth-3">(</span>trimmed<span class="org-rainbow-delimiters-depth-4">[</span>j<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>.bit_length<span class="org-rainbow-delimiters-depth-3">()</span>, trimmed<span class="org-rainbow-delimiters-depth-3">[</span>j<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
                <span class="org-variable-name">run_length</span> <span class="org-operator">=</span> 0
            <span class="org-comment-delimiter"># </span><span class="org-comment">send EOB</span>
        <span class="org-keyword">if</span> <span class="org-keyword">not</span> <span class="org-rainbow-delimiters-depth-1">(</span>encoded<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-3">(</span>encoded<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-operator">-</span> 1<span class="org-rainbow-delimiters-depth-2">]</span> <span class="org-operator">==</span> eob<span class="org-rainbow-delimiters-depth-1">)</span>:
            encoded.append<span class="org-rainbow-delimiters-depth-1">(</span>eob<span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-keyword">return</span> encoded


<span class="org-keyword">def</span> <span class="org-function-name">get_freq_dict</span><span class="org-rainbow-delimiters-depth-1">(</span>array: <span class="org-builtin">list</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">-&gt;</span> <span class="org-builtin">dict</span>:
    <span class="org-doc">"""</span>
<span class="org-doc">    returns a dict where the keys are the values of the array, and the values are their frequencies</span>
<span class="org-doc">    :param numpy.ndarray array: intermediary stream as array</span>
<span class="org-doc">    :return: frequency table</span>
<span class="org-doc">    """</span>
    <span class="org-comment-delimiter">#</span>
    <span class="org-variable-name">data</span> <span class="org-operator">=</span> Counter<span class="org-rainbow-delimiters-depth-1">(</span>array<span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-variable-name">result</span> <span class="org-operator">=</span> <span class="org-rainbow-delimiters-depth-1">{</span>k: d <span class="org-operator">/</span> <span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-2">(</span>array<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">for</span> k, d <span class="org-keyword">in</span> data.items<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">}</span>
    <span class="org-keyword">return</span> result


<span class="org-keyword">def</span> <span class="org-function-name">find_huffman</span><span class="org-rainbow-delimiters-depth-1">(</span>p: <span class="org-builtin">dict</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">-&gt;</span> <span class="org-builtin">dict</span>:
    <span class="org-doc">"""</span>
<span class="org-doc">    returns a Huffman code for an ensemble with distribution p</span>
<span class="org-doc">    :param dict p: frequency table</span>
<span class="org-doc">    :returns: huffman code for each symbol</span>
<span class="org-doc">    """</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">Base case of only two symbols, assign 0 or 1 arbitrarily; frequency does not matter</span>
    <span class="org-keyword">if</span> <span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-1">(</span>p<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">==</span> 2:
        <span class="org-keyword">return</span> <span class="org-builtin">dict</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-builtin">zip</span><span class="org-rainbow-delimiters-depth-2">(</span>p.keys<span class="org-rainbow-delimiters-depth-3">()</span>, <span class="org-rainbow-delimiters-depth-3">[</span><span class="org-string">'0'</span>, <span class="org-string">'1'</span><span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

    <span class="org-comment-delimiter"># </span><span class="org-comment">Create a new distribution by merging lowest probable pair</span>
    <span class="org-variable-name">p_prime</span> <span class="org-operator">=</span> p.copy<span class="org-rainbow-delimiters-depth-1">()</span>
    <span class="org-variable-name">a1</span>, <span class="org-variable-name">a2</span> <span class="org-operator">=</span> lowest_prob_pair<span class="org-rainbow-delimiters-depth-1">(</span>p<span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-variable-name">p1</span>, <span class="org-variable-name">p2</span> <span class="org-operator">=</span> p_prime.pop<span class="org-rainbow-delimiters-depth-1">(</span>a1<span class="org-rainbow-delimiters-depth-1">)</span>, p_prime.pop<span class="org-rainbow-delimiters-depth-1">(</span>a2<span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-variable-name">p_prime</span><span class="org-rainbow-delimiters-depth-1">[</span>a1 <span class="org-operator">+</span> a2<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> p1 <span class="org-operator">+</span> p2

    <span class="org-comment-delimiter"># </span><span class="org-comment">Recurse and construct code on new distribution</span>
    <span class="org-variable-name">c</span> <span class="org-operator">=</span> find_huffman<span class="org-rainbow-delimiters-depth-1">(</span>p_prime<span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-variable-name">ca1a2</span> <span class="org-operator">=</span> c.pop<span class="org-rainbow-delimiters-depth-1">(</span>a1 <span class="org-operator">+</span> a2<span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-variable-name">c</span><span class="org-rainbow-delimiters-depth-1">[</span><span class="org-variable-name">a1</span><span class="org-rainbow-delimiters-depth-1">]</span>, <span class="org-variable-name">c</span><span class="org-rainbow-delimiters-depth-1">[</span>a2<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> ca1a2 <span class="org-operator">+</span> <span class="org-string">'0'</span>, ca1a2 <span class="org-operator">+</span> <span class="org-string">'1'</span>

    <span class="org-keyword">return</span> c


<span class="org-keyword">def</span> <span class="org-function-name">lowest_prob_pair</span><span class="org-rainbow-delimiters-depth-1">(</span>p<span class="org-rainbow-delimiters-depth-1">)</span>:
    <span class="org-comment-delimiter"># </span><span class="org-comment">Return pair of symbols from distribution p with lowest probabilities</span>
    <span class="org-variable-name">sorted_p</span> <span class="org-operator">=</span> <span class="org-builtin">sorted</span><span class="org-rainbow-delimiters-depth-1">(</span>p.items<span class="org-rainbow-delimiters-depth-2">()</span>, key<span class="org-operator">=</span><span class="org-keyword">lambda</span> x: x<span class="org-rainbow-delimiters-depth-2">[</span>1<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-keyword">return</span> sorted_p<span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">][</span>0<span class="org-rainbow-delimiters-depth-1">]</span>, sorted_p<span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">][</span>0<span class="org-rainbow-delimiters-depth-1">]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="orgdf44e99"><span class="org-keyword">from</span> math <span class="org-keyword">import</span> ceil

<span class="org-keyword">import</span> cv2
<span class="org-keyword">import</span> numpy <span class="org-keyword">as</span> np

<span class="org-comment-delimiter"># </span><span class="org-comment">define quantization tables</span>
<span class="org-variable-name">QTY</span> <span class="org-operator">=</span> np.array<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">[</span><span class="org-rainbow-delimiters-depth-3">[</span>16, 11, 10, 16, 24, 40, 51, 61<span class="org-rainbow-delimiters-depth-3">]</span>,  <span class="org-comment-delimiter"># </span><span class="org-comment">luminance quantization table</span>
                <span class="org-rainbow-delimiters-depth-3">[</span>12, 12, 14, 19, 26, 48, 60, 55<span class="org-rainbow-delimiters-depth-3">]</span>,
                <span class="org-rainbow-delimiters-depth-3">[</span>14, 13, 16, 24, 40, 57, 69, 56<span class="org-rainbow-delimiters-depth-3">]</span>,
                <span class="org-rainbow-delimiters-depth-3">[</span>14, 17, 22, 29, 51, 87, 80, 62<span class="org-rainbow-delimiters-depth-3">]</span>,
                <span class="org-rainbow-delimiters-depth-3">[</span>18, 22, 37, 56, 68, 109, 103, 77<span class="org-rainbow-delimiters-depth-3">]</span>,
                <span class="org-rainbow-delimiters-depth-3">[</span>24, 35, 55, 64, 81, 104, 113, 92<span class="org-rainbow-delimiters-depth-3">]</span>,
                <span class="org-rainbow-delimiters-depth-3">[</span>49, 64, 78, 87, 103, 121, 120, 101<span class="org-rainbow-delimiters-depth-3">]</span>,
                <span class="org-rainbow-delimiters-depth-3">[</span>72, 92, 95, 98, 112, 100, 103, 99<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-variable-name">QTC</span> <span class="org-operator">=</span> np.array<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">[</span><span class="org-rainbow-delimiters-depth-3">[</span>17, 18, 24, 47, 99, 99, 99, 99<span class="org-rainbow-delimiters-depth-3">]</span>,  <span class="org-comment-delimiter"># </span><span class="org-comment">chrominance quantization table</span>
                <span class="org-rainbow-delimiters-depth-3">[</span>18, 21, 26, 66, 99, 99, 99, 99<span class="org-rainbow-delimiters-depth-3">]</span>,
                <span class="org-rainbow-delimiters-depth-3">[</span>24, 26, 56, 99, 99, 99, 99, 99<span class="org-rainbow-delimiters-depth-3">]</span>,
                <span class="org-rainbow-delimiters-depth-3">[</span>47, 66, 99, 99, 99, 99, 99, 99<span class="org-rainbow-delimiters-depth-3">]</span>,
                <span class="org-rainbow-delimiters-depth-3">[</span>99, 99, 99, 99, 99, 99, 99, 99<span class="org-rainbow-delimiters-depth-3">]</span>,
                <span class="org-rainbow-delimiters-depth-3">[</span>99, 99, 99, 99, 99, 99, 99, 99<span class="org-rainbow-delimiters-depth-3">]</span>,
                <span class="org-rainbow-delimiters-depth-3">[</span>99, 99, 99, 99, 99, 99, 99, 99<span class="org-rainbow-delimiters-depth-3">]</span>,
                <span class="org-rainbow-delimiters-depth-3">[</span>99, 99, 99, 99, 99, 99, 99, 99<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">define window size</span>
<span class="org-variable-name">windowSize</span> <span class="org-operator">=</span> <span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-1">(</span>QTY<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">read image</span>
<span class="org-variable-name">imgOriginal</span> <span class="org-operator">=</span> cv2.imread<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"/Users/danielmcguiness/Downloads/JPEG-Image-Compressor-main/marbles.bmp"</span>, cv2.IMREAD_COLOR<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">convert BGR to YCrCb</span>
<span class="org-variable-name">img</span> <span class="org-operator">=</span> cv2.cvtColor<span class="org-rainbow-delimiters-depth-1">(</span>imgOriginal, cv2.COLOR_BGR2YCR_CB<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">width</span> <span class="org-operator">=</span> <span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-1">(</span>img<span class="org-rainbow-delimiters-depth-2">[</span>0<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">height</span> <span class="org-operator">=</span> <span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-1">(</span>img<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">y</span> <span class="org-operator">=</span> np.zeros<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>height, width<span class="org-rainbow-delimiters-depth-2">)</span>, np.float32<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">+</span> img<span class="org-rainbow-delimiters-depth-1">[</span>:, :, 0<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-variable-name">cr</span> <span class="org-operator">=</span> np.zeros<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>height, width<span class="org-rainbow-delimiters-depth-2">)</span>, np.float32<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">+</span> img<span class="org-rainbow-delimiters-depth-1">[</span>:, :, 1<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-variable-name">cb</span> <span class="org-operator">=</span> np.zeros<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>height, width<span class="org-rainbow-delimiters-depth-2">)</span>, np.float32<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">+</span> img<span class="org-rainbow-delimiters-depth-1">[</span>:, :, 2<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">size of the image in bits before compression</span>
<span class="org-variable-name">totalNumberOfBitsWithoutCompression</span> <span class="org-operator">=</span> <span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-1">(</span>y<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">*</span> <span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-1">(</span>y<span class="org-rainbow-delimiters-depth-2">[</span>0<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">*</span> 8 <span class="org-operator">+</span> <span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-1">(</span>cb<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">*</span> <span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-1">(</span>cb<span class="org-rainbow-delimiters-depth-2">[</span>0<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">*</span> 8 <span class="org-operator">+</span> <span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-1">(</span>cr<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">*</span> <span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-1">(</span>cr<span class="org-rainbow-delimiters-depth-2">[</span>0<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">*</span> 8
<span class="org-comment-delimiter"># </span><span class="org-comment">channel values should be normalized, hence subtract 128</span>
<span class="org-variable-name">y</span> <span class="org-operator">=</span> y <span class="org-operator">-</span> 128
<span class="org-variable-name">cr</span> <span class="org-operator">=</span> cr <span class="org-operator">-</span> 128
<span class="org-variable-name">cb</span> <span class="org-operator">=</span> cb <span class="org-operator">-</span> 128
<span class="org-comment-delimiter"># </span><span class="org-comment">4: 2: 2 subsampling is used # another subsampling scheme can be used</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">thus chrominance channels should be sub-sampled</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">define subsampling factors in both horizontal and vertical directions</span>
<span class="org-variable-name">SSH</span>, <span class="org-variable-name">SSV</span> <span class="org-operator">=</span> 2, 2
<span class="org-comment-delimiter"># </span><span class="org-comment">filter the chrominance channels using a 2x2 averaging filter # another type of filter can be used</span>
<span class="org-variable-name">crf</span> <span class="org-operator">=</span> cv2.boxFilter<span class="org-rainbow-delimiters-depth-1">(</span>cr, ddepth<span class="org-operator">=-</span>1, ksize<span class="org-operator">=</span><span class="org-rainbow-delimiters-depth-2">(</span>2, 2<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">cbf</span> <span class="org-operator">=</span> cv2.boxFilter<span class="org-rainbow-delimiters-depth-1">(</span>cb, ddepth<span class="org-operator">=-</span>1, ksize<span class="org-operator">=</span><span class="org-rainbow-delimiters-depth-2">(</span>2, 2<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">crSub</span> <span class="org-operator">=</span> crf<span class="org-rainbow-delimiters-depth-1">[</span>::SSV, ::SSH<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-variable-name">cbSub</span> <span class="org-operator">=</span> cbf<span class="org-rainbow-delimiters-depth-1">[</span>::SSV, ::SSH<span class="org-rainbow-delimiters-depth-1">]</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">check if padding is needed,</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">if yes define empty arrays to pad each channel DCT with zeros if necessary</span>
<span class="org-variable-name">yWidth</span>, <span class="org-variable-name">yLength</span> <span class="org-operator">=</span> ceil<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-2">(</span>y<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-operator">/</span> windowSize<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">*</span> windowSize, ceil<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-2">(</span>y<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-operator">/</span> windowSize<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">*</span> windowSize
<span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-2">(</span>y<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-operator">%</span> windowSize <span class="org-operator">==</span> 0<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">and</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-2">(</span>y<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-operator">%</span> windowSize <span class="org-operator">==</span> 0<span class="org-rainbow-delimiters-depth-1">)</span>:
    <span class="org-variable-name">yPadded</span> <span class="org-operator">=</span> y.copy<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-keyword">else</span>:
    <span class="org-variable-name">yPadded</span> <span class="org-operator">=</span> np.zeros<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>yLength, yWidth<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-2">(</span>y<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>:
        <span class="org-keyword">for</span> j <span class="org-keyword">in</span> <span class="org-builtin">range</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-2">(</span>y<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>:
            <span class="org-variable-name">yPadded</span><span class="org-rainbow-delimiters-depth-1">[</span><span class="org-variable-name">i</span>, <span class="org-variable-name">j</span><span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">+=</span> y<span class="org-rainbow-delimiters-depth-1">[</span>i, j<span class="org-rainbow-delimiters-depth-1">]</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">chrominance channels have the same dimensions, meaning both can be padded in one loop</span>
<span class="org-variable-name">cWidth</span>, <span class="org-variable-name">cLength</span> <span class="org-operator">=</span> ceil<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-2">(</span>cbSub<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-operator">/</span> windowSize<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">*</span> windowSize, ceil<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-2">(</span>cbSub<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-operator">/</span> windowSize<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">*</span> windowSize
<span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-2">(</span>cbSub<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-operator">%</span> windowSize <span class="org-operator">==</span> 0<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">and</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-2">(</span>cbSub<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-operator">%</span> windowSize <span class="org-operator">==</span> 0<span class="org-rainbow-delimiters-depth-1">)</span>:
    <span class="org-variable-name">crPadded</span> <span class="org-operator">=</span> crSub.copy<span class="org-rainbow-delimiters-depth-1">()</span>
    <span class="org-variable-name">cbPadded</span> <span class="org-operator">=</span> cbSub.copy<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">since chrominance channels have the same dimensions, one loop is enough</span>
<span class="org-keyword">else</span>:
    <span class="org-variable-name">crPadded</span> <span class="org-operator">=</span> np.zeros<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>cLength, cWidth<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-variable-name">cbPadded</span> <span class="org-operator">=</span> np.zeros<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>cLength, cWidth<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-2">(</span>crSub<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>:
        <span class="org-keyword">for</span> j <span class="org-keyword">in</span> <span class="org-builtin">range</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-2">(</span>crSub<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>:
            <span class="org-variable-name">crPadded</span><span class="org-rainbow-delimiters-depth-1">[</span><span class="org-variable-name">i</span>, <span class="org-variable-name">j</span><span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">+=</span> crSub<span class="org-rainbow-delimiters-depth-1">[</span>i, j<span class="org-rainbow-delimiters-depth-1">]</span>
            <span class="org-variable-name">cbPadded</span><span class="org-rainbow-delimiters-depth-1">[</span><span class="org-variable-name">i</span>, <span class="org-variable-name">j</span><span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">+=</span> cbSub<span class="org-rainbow-delimiters-depth-1">[</span>i, j<span class="org-rainbow-delimiters-depth-1">]</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">get DCT of each channel</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">define three empty matrices</span>
<span class="org-variable-name">yDct</span>, <span class="org-variable-name">crDct</span>, <span class="org-variable-name">cbDct</span> <span class="org-operator">=</span> np.zeros<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>yLength, yWidth<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>, np.zeros<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>cLength, cWidth<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>, np.zeros<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>cLength, cWidth<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">number of iteration on x axis and y axis to calculate the luminance cosine transform values</span>
<span class="org-variable-name">hBlocksForY</span> <span class="org-operator">=</span> <span class="org-builtin">int</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-2">(</span>yDct<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-operator">/</span> windowSize<span class="org-rainbow-delimiters-depth-1">)</span>  <span class="org-comment-delimiter"># </span><span class="org-comment">number of blocks in the horizontal direction for luminance</span>
<span class="org-variable-name">vBlocksForY</span> <span class="org-operator">=</span> <span class="org-builtin">int</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-2">(</span>yDct<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-operator">/</span> windowSize<span class="org-rainbow-delimiters-depth-1">)</span>  <span class="org-comment-delimiter"># </span><span class="org-comment">number of blocks in the vertical direction for luminance</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">number of iteration on x axis and y axis to calculate the chrominance channels cosine transforms values</span>
<span class="org-variable-name">hBlocksForC</span> <span class="org-operator">=</span> <span class="org-builtin">int</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-2">(</span>crDct<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-operator">/</span> windowSize<span class="org-rainbow-delimiters-depth-1">)</span>  <span class="org-comment-delimiter"># </span><span class="org-comment">number of blocks in the horizontal direction for chrominance</span>
<span class="org-variable-name">vBlocksForC</span> <span class="org-operator">=</span> <span class="org-builtin">int</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-2">(</span>crDct<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-operator">/</span> windowSize<span class="org-rainbow-delimiters-depth-1">)</span>  <span class="org-comment-delimiter"># </span><span class="org-comment">number of blocks in the vertical direction for chrominance</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">define 3 empty matrices to store the quantized values</span>
<span class="org-variable-name">yq</span>, <span class="org-variable-name">crq</span>, <span class="org-variable-name">cbq</span> <span class="org-operator">=</span> np.zeros<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>yLength, yWidth<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>, np.zeros<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>cLength, cWidth<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>, np.zeros<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>cLength, cWidth<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">and another 3 for the zigzags</span>
<span class="org-variable-name">yZigzag</span> <span class="org-operator">=</span> np.zeros<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">(</span>vBlocksForY <span class="org-operator">*</span> hBlocksForY<span class="org-rainbow-delimiters-depth-3">)</span>, windowSize <span class="org-operator">*</span> windowSize<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">crZigzag</span> <span class="org-operator">=</span> np.zeros<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">(</span>vBlocksForC <span class="org-operator">*</span> hBlocksForC<span class="org-rainbow-delimiters-depth-3">)</span>, windowSize <span class="org-operator">*</span> windowSize<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">cbZigzag</span> <span class="org-operator">=</span> np.zeros<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">(</span>vBlocksForC <span class="org-operator">*</span> hBlocksForC<span class="org-rainbow-delimiters-depth-3">)</span>, windowSize <span class="org-operator">*</span> windowSize<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-variable-name">yCounter</span> <span class="org-operator">=</span> 0
<span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span><span class="org-rainbow-delimiters-depth-1">(</span>vBlocksForY<span class="org-rainbow-delimiters-depth-1">)</span>:
    <span class="org-keyword">for</span> j <span class="org-keyword">in</span> <span class="org-builtin">range</span><span class="org-rainbow-delimiters-depth-1">(</span>hBlocksForY<span class="org-rainbow-delimiters-depth-1">)</span>:
        <span class="org-variable-name">yDct</span><span class="org-rainbow-delimiters-depth-1">[</span>i <span class="org-operator">*</span> windowSize: i <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize, j <span class="org-operator">*</span> windowSize: j <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> cv2.dct<span class="org-rainbow-delimiters-depth-1">(</span>
            yPadded<span class="org-rainbow-delimiters-depth-2">[</span>i <span class="org-operator">*</span> windowSize: i <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize, j <span class="org-operator">*</span> windowSize: j <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
        <span class="org-variable-name">yq</span><span class="org-rainbow-delimiters-depth-1">[</span>i <span class="org-operator">*</span> windowSize: i <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize, j <span class="org-operator">*</span> windowSize: j <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> np.ceil<span class="org-rainbow-delimiters-depth-1">(</span>
            yDct<span class="org-rainbow-delimiters-depth-2">[</span>i <span class="org-operator">*</span> windowSize: i <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize, j <span class="org-operator">*</span> windowSize: j <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize<span class="org-rainbow-delimiters-depth-2">]</span> <span class="org-operator">/</span> QTY<span class="org-rainbow-delimiters-depth-1">)</span>
        <span class="org-variable-name">yZigzag</span><span class="org-rainbow-delimiters-depth-1">[</span>yCounter<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">+=</span> zigzag<span class="org-rainbow-delimiters-depth-1">(</span>
            yq<span class="org-rainbow-delimiters-depth-2">[</span>i <span class="org-operator">*</span> windowSize: i <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize, j <span class="org-operator">*</span> windowSize: j <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
        <span class="org-variable-name">yCounter</span> <span class="org-operator">+=</span> 1
<span class="org-variable-name">yZigzag</span> <span class="org-operator">=</span> yZigzag.astype<span class="org-rainbow-delimiters-depth-1">(</span>np.int16<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">either crq or cbq can be used to compute the number of blocks</span>
<span class="org-variable-name">cCounter</span> <span class="org-operator">=</span> 0
<span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span><span class="org-rainbow-delimiters-depth-1">(</span>vBlocksForC<span class="org-rainbow-delimiters-depth-1">)</span>:
    <span class="org-keyword">for</span> j <span class="org-keyword">in</span> <span class="org-builtin">range</span><span class="org-rainbow-delimiters-depth-1">(</span>hBlocksForC<span class="org-rainbow-delimiters-depth-1">)</span>:
        <span class="org-variable-name">crDct</span><span class="org-rainbow-delimiters-depth-1">[</span>i <span class="org-operator">*</span> windowSize: i <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize, j <span class="org-operator">*</span> windowSize: j <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> cv2.dct<span class="org-rainbow-delimiters-depth-1">(</span>
            crPadded<span class="org-rainbow-delimiters-depth-2">[</span>i <span class="org-operator">*</span> windowSize: i <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize, j <span class="org-operator">*</span> windowSize: j <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
        <span class="org-variable-name">crq</span><span class="org-rainbow-delimiters-depth-1">[</span>i <span class="org-operator">*</span> windowSize: i <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize, j <span class="org-operator">*</span> windowSize: j <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> np.ceil<span class="org-rainbow-delimiters-depth-1">(</span>
            crDct<span class="org-rainbow-delimiters-depth-2">[</span>i <span class="org-operator">*</span> windowSize: i <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize, j <span class="org-operator">*</span> windowSize: j <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize<span class="org-rainbow-delimiters-depth-2">]</span> <span class="org-operator">/</span> QTC<span class="org-rainbow-delimiters-depth-1">)</span>
        <span class="org-variable-name">crZigzag</span><span class="org-rainbow-delimiters-depth-1">[</span>cCounter<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">+=</span> zigzag<span class="org-rainbow-delimiters-depth-1">(</span>
            crq<span class="org-rainbow-delimiters-depth-2">[</span>i <span class="org-operator">*</span> windowSize: i <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize, j <span class="org-operator">*</span> windowSize: j <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
        <span class="org-variable-name">cbDct</span><span class="org-rainbow-delimiters-depth-1">[</span>i <span class="org-operator">*</span> windowSize: i <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize, j <span class="org-operator">*</span> windowSize: j <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> cv2.dct<span class="org-rainbow-delimiters-depth-1">(</span>
            cbPadded<span class="org-rainbow-delimiters-depth-2">[</span>i <span class="org-operator">*</span> windowSize: i <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize, j <span class="org-operator">*</span> windowSize: j <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
        <span class="org-variable-name">cbq</span><span class="org-rainbow-delimiters-depth-1">[</span>i <span class="org-operator">*</span> windowSize: i <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize, j <span class="org-operator">*</span> windowSize: j <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> np.ceil<span class="org-rainbow-delimiters-depth-1">(</span>
            cbDct<span class="org-rainbow-delimiters-depth-2">[</span>i <span class="org-operator">*</span> windowSize: i <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize, j <span class="org-operator">*</span> windowSize: j <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize<span class="org-rainbow-delimiters-depth-2">]</span> <span class="org-operator">/</span> QTC<span class="org-rainbow-delimiters-depth-1">)</span>
        <span class="org-variable-name">cbZigzag</span><span class="org-rainbow-delimiters-depth-1">[</span>cCounter<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">+=</span> zigzag<span class="org-rainbow-delimiters-depth-1">(</span>
            cbq<span class="org-rainbow-delimiters-depth-2">[</span>i <span class="org-operator">*</span> windowSize: i <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize, j <span class="org-operator">*</span> windowSize: j <span class="org-operator">*</span> windowSize <span class="org-operator">+</span> windowSize<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
        <span class="org-variable-name">cCounter</span> <span class="org-operator">+=</span> 1
<span class="org-variable-name">crZigzag</span> <span class="org-operator">=</span> crZigzag.astype<span class="org-rainbow-delimiters-depth-1">(</span>np.int16<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">cbZigzag</span> <span class="org-operator">=</span> cbZigzag.astype<span class="org-rainbow-delimiters-depth-1">(</span>np.int16<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">find the run length encoding for each channel</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">then get the frequency of each component in order to form a Huffman dictionary</span>
<span class="org-variable-name">yEncoded</span> <span class="org-operator">=</span> run_length_encoding<span class="org-rainbow-delimiters-depth-1">(</span>yZigzag<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">yFrequencyTable</span> <span class="org-operator">=</span> get_freq_dict<span class="org-rainbow-delimiters-depth-1">(</span>yEncoded<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">yHuffman</span> <span class="org-operator">=</span> find_huffman<span class="org-rainbow-delimiters-depth-1">(</span>yFrequencyTable<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-variable-name">crEncoded</span> <span class="org-operator">=</span> run_length_encoding<span class="org-rainbow-delimiters-depth-1">(</span>crZigzag<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">crFrequencyTable</span> <span class="org-operator">=</span> get_freq_dict<span class="org-rainbow-delimiters-depth-1">(</span>crEncoded<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">crHuffman</span> <span class="org-operator">=</span> find_huffman<span class="org-rainbow-delimiters-depth-1">(</span>crFrequencyTable<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-variable-name">cbEncoded</span> <span class="org-operator">=</span> run_length_encoding<span class="org-rainbow-delimiters-depth-1">(</span>cbZigzag<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">cbFrequencyTable</span> <span class="org-operator">=</span> get_freq_dict<span class="org-rainbow-delimiters-depth-1">(</span>cbEncoded<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">cbHuffman</span> <span class="org-operator">=</span> find_huffman<span class="org-rainbow-delimiters-depth-1">(</span>cbFrequencyTable<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">calculate the number of bits to transmit for each channel</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">and write them to an output file</span>
<span class="org-builtin">file</span> <span class="org-operator">=</span> <span class="org-builtin">open</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"CompressedImage.asfh"</span>, <span class="org-string">"w"</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">yBitsToTransmit</span> <span class="org-operator">=</span> <span class="org-builtin">str</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-keyword">for</span> value <span class="org-keyword">in</span> yEncoded:
    <span class="org-variable-name">yBitsToTransmit</span> <span class="org-operator">+=</span> yHuffman<span class="org-rainbow-delimiters-depth-1">[</span>value<span class="org-rainbow-delimiters-depth-1">]</span>

<span class="org-variable-name">crBitsToTransmit</span> <span class="org-operator">=</span> <span class="org-builtin">str</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-keyword">for</span> value <span class="org-keyword">in</span> crEncoded:
    <span class="org-variable-name">crBitsToTransmit</span> <span class="org-operator">+=</span> crHuffman<span class="org-rainbow-delimiters-depth-1">[</span>value<span class="org-rainbow-delimiters-depth-1">]</span>

<span class="org-variable-name">cbBitsToTransmit</span> <span class="org-operator">=</span> <span class="org-builtin">str</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-keyword">for</span> value <span class="org-keyword">in</span> cbEncoded:
    <span class="org-variable-name">cbBitsToTransmit</span> <span class="org-operator">+=</span> cbHuffman<span class="org-rainbow-delimiters-depth-1">[</span>value<span class="org-rainbow-delimiters-depth-1">]</span>

<span class="org-keyword">if</span> <span class="org-builtin">file</span>.writable<span class="org-rainbow-delimiters-depth-1">()</span>:
    <span class="org-builtin">file</span>.write<span class="org-rainbow-delimiters-depth-1">(</span>yBitsToTransmit <span class="org-operator">+</span> <span class="org-string">"</span><span class="org-constant">\n</span><span class="org-string">"</span> <span class="org-operator">+</span> crBitsToTransmit <span class="org-operator">+</span> <span class="org-string">"</span><span class="org-constant">\n</span><span class="org-string">"</span> <span class="org-operator">+</span> cbBitsToTransmit<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-builtin">file</span>.close<span class="org-rainbow-delimiters-depth-1">()</span>

<span class="org-variable-name">totalNumberOfBitsAfterCompression</span> <span class="org-operator">=</span> <span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-1">(</span>yBitsToTransmit<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">+</span> <span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-1">(</span>crBitsToTransmit<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-operator">+</span> <span class="org-builtin">len</span><span class="org-rainbow-delimiters-depth-1">(</span>cbBitsToTransmit<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-builtin">print</span><span class="org-rainbow-delimiters-depth-1">(</span>
    <span class="org-string">"Compression Ratio is "</span> <span class="org-operator">+</span> <span class="org-builtin">str</span><span class="org-rainbow-delimiters-depth-2">(</span>
        np.<span class="org-builtin">round</span><span class="org-rainbow-delimiters-depth-3">(</span>totalNumberOfBitsWithoutCompression <span class="org-operator">/</span> totalNumberOfBitsAfterCompression, 1<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

</pre>
</div>


<div class="org-src-container">
<pre class="src src-python" id="orgff625ed"><span class="org-keyword">from</span> scipy.fft <span class="org-keyword">import</span> dct

<span class="org-keyword">def</span> <span class="org-function-name">dct2d</span><span class="org-rainbow-delimiters-depth-1">(</span>x<span class="org-rainbow-delimiters-depth-1">)</span>:
    <span class="org-variable-name">out</span> <span class="org-operator">=</span> dct<span class="org-rainbow-delimiters-depth-1">(</span>dct<span class="org-rainbow-delimiters-depth-2">(</span>x, norm<span class="org-operator">=</span><span class="org-string">'ortho'</span>, axis<span class="org-operator">=</span>0<span class="org-rainbow-delimiters-depth-2">)</span>, norm<span class="org-operator">=</span><span class="org-string">'ortho'</span>, axis<span class="org-operator">=</span>1<span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-keyword">return</span> out
</pre>
</div>


<div class="org-src-container">
<pre class="src src-python" id="org803d493"><span class="org-keyword">from</span> scipy.fft <span class="org-keyword">import</span> dct

<span class="org-keyword">def</span> <span class="org-function-name">idct2d</span><span class="org-rainbow-delimiters-depth-1">(</span>x<span class="org-rainbow-delimiters-depth-1">)</span>:
    <span class="org-variable-name">out</span> <span class="org-operator">=</span> dct<span class="org-rainbow-delimiters-depth-1">(</span>dct<span class="org-rainbow-delimiters-depth-2">(</span>out, <span class="org-builtin">type</span><span class="org-operator">=</span>3, norm<span class="org-operator">=</span><span class="org-string">'ortho'</span>, axis<span class="org-operator">=</span>0<span class="org-rainbow-delimiters-depth-2">)</span>,
              <span class="org-builtin">type</span><span class="org-operator">=</span>3,
              norm<span class="org-operator">=</span><span class="org-string">'ortho'</span>,
              axis<span class="org-operator">=</span>1<span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-keyword">return</span> out
</pre>
</div>
</div>
</div>


<div id="outline-container-org94ffe50" class="outline-2">
<h2 id="org94ffe50">JPEG Compression</h2>
<div class="outline-text-2" id="text-org94ffe50">
<div class="org-src-container">
<pre class="src src-python" id="org3b96f05"><span class="org-doc">"""</span>
<span class="org-doc">Image compression util functions.</span>

<span class="org-doc">@author: khe</span>
<span class="org-doc">"""</span>
<span class="org-keyword">import</span> numpy <span class="org-keyword">as</span> np
<span class="org-keyword">from</span> scipy.fft <span class="org-keyword">import</span> dct
<span class="org-keyword">from</span> scipy.signal <span class="org-keyword">import</span> convolve2d

<span class="org-keyword">class</span> <span class="org-type">Downsampling</span><span class="org-rainbow-delimiters-depth-1">()</span>:
    <span class="org-keyword">def</span> <span class="org-function-name">__init__</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">self</span>, ratio<span class="org-operator">=</span><span class="org-string">'4:2:0'</span><span class="org-rainbow-delimiters-depth-1">)</span>:
        <span class="org-keyword">assert</span> ratio <span class="org-keyword">in</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">'4:4:4'</span>, <span class="org-string">'4:2:2'</span>, <span class="org-string">'4:2:0'</span><span class="org-rainbow-delimiters-depth-1">)</span>, <span class="org-string">"Please choose one of the following {'4:4:4', '4:2:2', '4:2:0'}"</span>
        <span class="org-keyword">self</span>.<span class="org-variable-name">ratio</span> <span class="org-operator">=</span> ratio

    <span class="org-keyword">def</span> <span class="org-function-name">__call__</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">self</span>, x<span class="org-rainbow-delimiters-depth-1">)</span>:
        <span class="org-comment-delimiter"># </span><span class="org-comment">No subsampling</span>
        <span class="org-keyword">if</span> <span class="org-keyword">self</span>.ratio <span class="org-operator">==</span> <span class="org-string">'4:4:4'</span>:
            <span class="org-keyword">return</span> x
        <span class="org-keyword">else</span>:
            <span class="org-comment-delimiter"># </span><span class="org-comment">Downsample with a window of 2 in the horizontal direction</span>
            <span class="org-keyword">if</span> <span class="org-keyword">self</span>.ratio <span class="org-operator">==</span> <span class="org-string">'4:2:2'</span>:
                <span class="org-variable-name">kernel</span> <span class="org-operator">=</span> np.array<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">[</span><span class="org-rainbow-delimiters-depth-3">[</span>0.5<span class="org-rainbow-delimiters-depth-3">]</span>, <span class="org-rainbow-delimiters-depth-3">[</span>0.5<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
                <span class="org-variable-name">out</span> <span class="org-operator">=</span> np.repeat<span class="org-rainbow-delimiters-depth-1">(</span>convolve2d<span class="org-rainbow-delimiters-depth-2">(</span>x, kernel, mode<span class="org-operator">=</span><span class="org-string">'valid'</span><span class="org-rainbow-delimiters-depth-2">)[</span>::2,:<span class="org-rainbow-delimiters-depth-2">]</span>, 2, axis<span class="org-operator">=</span>0<span class="org-rainbow-delimiters-depth-1">)</span>
                <span class="org-comment-delimiter"># </span><span class="org-comment">Downsample with a window of 2 in both directions</span>
            <span class="org-keyword">else</span>:
                <span class="org-variable-name">kernel</span> <span class="org-operator">=</span> np.array<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">[</span><span class="org-rainbow-delimiters-depth-3">[</span>0.25, 0.25<span class="org-rainbow-delimiters-depth-3">]</span>, <span class="org-rainbow-delimiters-depth-3">[</span>0.25, 0.25<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
                <span class="org-variable-name">out</span> <span class="org-operator">=</span> np.repeat<span class="org-rainbow-delimiters-depth-1">(</span>np.repeat<span class="org-rainbow-delimiters-depth-2">(</span>convolve2d<span class="org-rainbow-delimiters-depth-3">(</span>x, kernel, mode<span class="org-operator">=</span><span class="org-string">'valid'</span><span class="org-rainbow-delimiters-depth-3">)[</span>::2,::2<span class="org-rainbow-delimiters-depth-3">]</span>, 2, axis<span class="org-operator">=</span>0<span class="org-rainbow-delimiters-depth-2">)</span>, 2, axis<span class="org-operator">=</span>1<span class="org-rainbow-delimiters-depth-1">)</span>
            <span class="org-keyword">return</span> np.<span class="org-builtin">round</span><span class="org-rainbow-delimiters-depth-1">(</span>out<span class="org-rainbow-delimiters-depth-1">)</span>.astype<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">'int'</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-keyword">class</span> <span class="org-type">ImageBlock</span><span class="org-rainbow-delimiters-depth-1">()</span>:
    <span class="org-keyword">def</span> <span class="org-function-name">__init__</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">self</span>, block_height<span class="org-operator">=</span>8, block_width<span class="org-operator">=</span>8<span class="org-rainbow-delimiters-depth-1">)</span>:
        <span class="org-keyword">self</span>.<span class="org-variable-name">block_height</span> <span class="org-operator">=</span> block_height
        <span class="org-keyword">self</span>.<span class="org-variable-name">block_width</span> <span class="org-operator">=</span> block_width
        <span class="org-keyword">self</span>.<span class="org-variable-name">left_padding</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.right_padding <span class="org-operator">=</span> <span class="org-keyword">self</span>.top_padding <span class="org-operator">=</span> <span class="org-keyword">self</span>.bottom_padding <span class="org-operator">=</span> 0

    <span class="org-keyword">def</span> <span class="org-function-name">forward</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">self</span>, image<span class="org-rainbow-delimiters-depth-1">)</span>:
        <span class="org-keyword">self</span>.<span class="org-variable-name">image_height</span> <span class="org-operator">=</span> image.shape<span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span>
        <span class="org-keyword">self</span>.<span class="org-variable-name">image_width</span> <span class="org-operator">=</span> image.shape<span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span>
        <span class="org-keyword">self</span>.<span class="org-variable-name">image_channel</span> <span class="org-operator">=</span> image.shape<span class="org-rainbow-delimiters-depth-1">[</span>2<span class="org-rainbow-delimiters-depth-1">]</span>

        <span class="org-comment-delimiter"># </span><span class="org-comment">Vertical padding</span>
        <span class="org-keyword">if</span> <span class="org-keyword">self</span>.image_height <span class="org-operator">%</span> <span class="org-keyword">self</span>.block_height <span class="org-operator">!=</span> 0:
            <span class="org-variable-name">vpad</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.image_height <span class="org-operator">%</span> <span class="org-keyword">self</span>.block_height
            <span class="org-keyword">self</span>.<span class="org-variable-name">top_padding</span> <span class="org-operator">=</span> vpad <span class="org-operator">//</span> 2 
            <span class="org-keyword">self</span>.<span class="org-variable-name">bottom_padding</span> <span class="org-operator">=</span> vpad <span class="org-operator">-</span> <span class="org-keyword">self</span>.top_padding
            <span class="org-variable-name">image</span> <span class="org-operator">=</span> np.concatenate<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>np.repeat<span class="org-rainbow-delimiters-depth-3">(</span>image<span class="org-rainbow-delimiters-depth-4">[</span>:1<span class="org-rainbow-delimiters-depth-4">]</span>, <span class="org-keyword">self</span>.top_padding, 0<span class="org-rainbow-delimiters-depth-3">)</span>, image, 
                                    np.repeat<span class="org-rainbow-delimiters-depth-3">(</span>image<span class="org-rainbow-delimiters-depth-4">[</span><span class="org-operator">-</span>1:<span class="org-rainbow-delimiters-depth-4">]</span>, <span class="org-keyword">self</span>.bottom_padding, 0<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>, axis<span class="org-operator">=</span>0<span class="org-rainbow-delimiters-depth-1">)</span>

        <span class="org-comment-delimiter"># </span><span class="org-comment">Horizontal padding</span>
        <span class="org-keyword">if</span> <span class="org-keyword">self</span>.image_width <span class="org-operator">%</span> <span class="org-keyword">self</span>.block_width <span class="org-operator">!=</span> 0:
            <span class="org-variable-name">hpad</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.image_width <span class="org-operator">%</span> <span class="org-keyword">self</span>.block_width
            <span class="org-keyword">self</span>.<span class="org-variable-name">left_padding</span> <span class="org-operator">=</span> hpad <span class="org-operator">//</span> 2 
            <span class="org-keyword">self</span>.<span class="org-variable-name">right_padding</span> <span class="org-operator">=</span> hpad <span class="org-operator">-</span> <span class="org-keyword">self</span>.left_padding
            <span class="org-variable-name">image</span> <span class="org-operator">=</span> np.concatenate<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>np.repeat<span class="org-rainbow-delimiters-depth-3">(</span>image<span class="org-rainbow-delimiters-depth-4">[</span>:,:1<span class="org-rainbow-delimiters-depth-4">]</span>, <span class="org-keyword">self</span>.left_padding, 1<span class="org-rainbow-delimiters-depth-3">)</span>, image, 
                                    np.repeat<span class="org-rainbow-delimiters-depth-3">(</span>image<span class="org-rainbow-delimiters-depth-4">[</span>:,<span class="org-operator">-</span>1:<span class="org-rainbow-delimiters-depth-4">]</span>, <span class="org-keyword">self</span>.right_padding, 1<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>, axis<span class="org-operator">=</span>1<span class="org-rainbow-delimiters-depth-1">)</span>

        <span class="org-comment-delimiter"># </span><span class="org-comment">Update dimension</span>
        <span class="org-keyword">self</span>.<span class="org-variable-name">image_height</span> <span class="org-operator">=</span> image.shape<span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span>
        <span class="org-keyword">self</span>.<span class="org-variable-name">image_width</span> <span class="org-operator">=</span> image.shape<span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span>

        <span class="org-comment-delimiter"># </span><span class="org-comment">Create blocks</span>
        <span class="org-variable-name">blocks</span> <span class="org-operator">=</span> <span class="org-rainbow-delimiters-depth-1">[]</span>
        <span class="org-variable-name">indices</span> <span class="org-operator">=</span> <span class="org-rainbow-delimiters-depth-1">[]</span>
        <span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span><span class="org-rainbow-delimiters-depth-1">(</span>0, <span class="org-keyword">self</span>.image_height, <span class="org-keyword">self</span>.block_height<span class="org-rainbow-delimiters-depth-1">)</span>:
            <span class="org-keyword">for</span> j <span class="org-keyword">in</span> <span class="org-builtin">range</span><span class="org-rainbow-delimiters-depth-1">(</span>0, <span class="org-keyword">self</span>.image_width, <span class="org-keyword">self</span>.block_width<span class="org-rainbow-delimiters-depth-1">)</span>:
                <span class="org-keyword">for</span> k <span class="org-keyword">in</span> <span class="org-builtin">range</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">self</span>.image_channel<span class="org-rainbow-delimiters-depth-1">)</span>:
                    blocks.append<span class="org-rainbow-delimiters-depth-1">(</span>image<span class="org-rainbow-delimiters-depth-2">[</span>i:i<span class="org-operator">+</span><span class="org-keyword">self</span>.block_height, j:j<span class="org-operator">+</span><span class="org-keyword">self</span>.block_width, k<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
                    indices.append<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>i,j,k<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

        <span class="org-variable-name">blocks</span> <span class="org-operator">=</span> np.array<span class="org-rainbow-delimiters-depth-1">(</span>blocks<span class="org-rainbow-delimiters-depth-1">)</span>
        <span class="org-variable-name">indices</span> <span class="org-operator">=</span> np.array<span class="org-rainbow-delimiters-depth-1">(</span>indices<span class="org-rainbow-delimiters-depth-1">)</span>
        <span class="org-keyword">return</span> blocks, indices

    <span class="org-keyword">def</span> <span class="org-function-name">backward</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">self</span>, blocks, indices<span class="org-rainbow-delimiters-depth-1">)</span>:
        <span class="org-comment-delimiter"># </span><span class="org-comment">Empty image array</span>
        <span class="org-variable-name">image</span> <span class="org-operator">=</span> np.zeros<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">self</span>.image_height, <span class="org-keyword">self</span>.image_width, <span class="org-keyword">self</span>.image_channel<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>.astype<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-builtin">int</span><span class="org-rainbow-delimiters-depth-1">)</span>
        <span class="org-keyword">for</span> block, index <span class="org-keyword">in</span> <span class="org-builtin">zip</span><span class="org-rainbow-delimiters-depth-1">(</span>blocks, indices<span class="org-rainbow-delimiters-depth-1">)</span>:
            <span class="org-variable-name">i</span>, <span class="org-variable-name">j</span>, <span class="org-variable-name">k</span> <span class="org-operator">=</span> index
            <span class="org-variable-name">image</span><span class="org-rainbow-delimiters-depth-1">[</span>i:i<span class="org-operator">+</span><span class="org-keyword">self</span>.block_height, j:j<span class="org-operator">+</span><span class="org-keyword">self</span>.<span class="org-variable-name">block_width</span>, <span class="org-variable-name">k</span><span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">=</span> block

        <span class="org-comment-delimiter"># </span><span class="org-comment">Remove padding</span>
        <span class="org-keyword">if</span> <span class="org-keyword">self</span>.top_padding <span class="org-operator">&gt;</span> 0:
            <span class="org-variable-name">image</span> <span class="org-operator">=</span> image<span class="org-rainbow-delimiters-depth-1">[</span><span class="org-keyword">self</span>.top_padding:,:,:<span class="org-rainbow-delimiters-depth-1">]</span>
        <span class="org-keyword">if</span> <span class="org-keyword">self</span>.bottom_padding <span class="org-operator">&gt;</span> 0:
            <span class="org-variable-name">image</span> <span class="org-operator">=</span> image<span class="org-rainbow-delimiters-depth-1">[</span>:<span class="org-operator">-</span><span class="org-keyword">self</span>.bottom_padding,:,:<span class="org-rainbow-delimiters-depth-1">]</span> 
        <span class="org-keyword">if</span> <span class="org-keyword">self</span>.left_padding <span class="org-operator">&gt;</span> 0:
            <span class="org-variable-name">image</span> <span class="org-operator">=</span> image<span class="org-rainbow-delimiters-depth-1">[</span>:,<span class="org-keyword">self</span>.left_padding:,:<span class="org-rainbow-delimiters-depth-1">]</span>
        <span class="org-keyword">if</span> <span class="org-keyword">self</span>.right_padding <span class="org-operator">&gt;</span> 0:
            <span class="org-variable-name">image</span> <span class="org-operator">=</span> image<span class="org-rainbow-delimiters-depth-1">[</span>:,:<span class="org-operator">-</span><span class="org-keyword">self</span>.right_padding,:<span class="org-rainbow-delimiters-depth-1">]</span>
        <span class="org-keyword">return</span> image

<span class="org-keyword">class</span> <span class="org-type">DCT2D</span><span class="org-rainbow-delimiters-depth-1">()</span>:
    <span class="org-keyword">def</span> <span class="org-function-name">__init__</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">self</span>, norm<span class="org-operator">=</span><span class="org-string">'ortho'</span><span class="org-rainbow-delimiters-depth-1">)</span>:
        <span class="org-keyword">if</span> norm <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-constant">None</span>:
            <span class="org-keyword">assert</span> norm <span class="org-operator">==</span> <span class="org-string">'ortho'</span>, <span class="org-string">"norm needs to be in {None, 'ortho'}"</span>
            <span class="org-keyword">self</span>.<span class="org-variable-name">norm</span> <span class="org-operator">=</span> norm

    <span class="org-keyword">def</span> <span class="org-function-name">forward</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">self</span>, x<span class="org-rainbow-delimiters-depth-1">)</span>:
        <span class="org-variable-name">out</span> <span class="org-operator">=</span> dct<span class="org-rainbow-delimiters-depth-1">(</span>dct<span class="org-rainbow-delimiters-depth-2">(</span>x, norm<span class="org-operator">=</span><span class="org-keyword">self</span>.norm, axis<span class="org-operator">=</span>0<span class="org-rainbow-delimiters-depth-2">)</span>, norm<span class="org-operator">=</span><span class="org-keyword">self</span>.norm, axis<span class="org-operator">=</span>1<span class="org-rainbow-delimiters-depth-1">)</span>
        <span class="org-keyword">return</span> out

    <span class="org-keyword">def</span> <span class="org-function-name">backward</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">self</span>,x<span class="org-rainbow-delimiters-depth-1">)</span>:
        <span class="org-variable-name">out</span> <span class="org-operator">=</span> dct<span class="org-rainbow-delimiters-depth-1">(</span>dct<span class="org-rainbow-delimiters-depth-2">(</span>x, <span class="org-builtin">type</span><span class="org-operator">=</span>3, norm<span class="org-operator">=</span><span class="org-keyword">self</span>.norm, axis<span class="org-operator">=</span>0<span class="org-rainbow-delimiters-depth-2">)</span>, <span class="org-builtin">type</span><span class="org-operator">=</span>3, norm<span class="org-operator">=</span><span class="org-keyword">self</span>.norm, axis<span class="org-operator">=</span>1<span class="org-rainbow-delimiters-depth-1">)</span>
        <span class="org-keyword">return</span> np.<span class="org-builtin">round</span><span class="org-rainbow-delimiters-depth-1">(</span>out<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-keyword">class</span> <span class="org-type">Quantization</span><span class="org-rainbow-delimiters-depth-1">()</span>:
    <span class="org-comment-delimiter"># </span><span class="org-comment">Qunatiztion matrices</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">https://www.impulseadventure.com/photo/jpeg-quantization.html</span>

    <span class="org-comment-delimiter"># </span><span class="org-comment">Luminance</span>
    <span class="org-variable-name">Q_lum</span> <span class="org-operator">=</span> np.array<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">[</span><span class="org-rainbow-delimiters-depth-3">[</span>16,11,10,16,24,40,51,61<span class="org-rainbow-delimiters-depth-3">]</span>,
                      <span class="org-rainbow-delimiters-depth-3">[</span>12,12,14,19,26,58,60,55<span class="org-rainbow-delimiters-depth-3">]</span>,
                      <span class="org-rainbow-delimiters-depth-3">[</span>14,13,16,24,40,57,69,56<span class="org-rainbow-delimiters-depth-3">]</span>,
                      <span class="org-rainbow-delimiters-depth-3">[</span>14,17,22,29,51,87,80,62<span class="org-rainbow-delimiters-depth-3">]</span>,
                      <span class="org-rainbow-delimiters-depth-3">[</span>18,22,37,56,68,109,103,77<span class="org-rainbow-delimiters-depth-3">]</span>,
                      <span class="org-rainbow-delimiters-depth-3">[</span>24,35,55,64,81,104,113,92<span class="org-rainbow-delimiters-depth-3">]</span>,
                      <span class="org-rainbow-delimiters-depth-3">[</span>49,64,78,87,103,121,120,101<span class="org-rainbow-delimiters-depth-3">]</span>,
                      <span class="org-rainbow-delimiters-depth-3">[</span>72,92,95,98,112,100,103,99<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">Chrominance</span>
    <span class="org-variable-name">Q_chr</span> <span class="org-operator">=</span> np.array<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">[</span><span class="org-rainbow-delimiters-depth-3">[</span>17,18,24,47,99,99,99,99<span class="org-rainbow-delimiters-depth-3">]</span>,
                      <span class="org-rainbow-delimiters-depth-3">[</span>18,21,26,66,99,99,99,99<span class="org-rainbow-delimiters-depth-3">]</span>,
                      <span class="org-rainbow-delimiters-depth-3">[</span>24,26,56,99,99,99,99,99<span class="org-rainbow-delimiters-depth-3">]</span>,
                      <span class="org-rainbow-delimiters-depth-3">[</span>47,66,99,99,99,99,99,99<span class="org-rainbow-delimiters-depth-3">]</span>,
                      <span class="org-rainbow-delimiters-depth-3">[</span>99,99,99,99,99,99,99,99<span class="org-rainbow-delimiters-depth-3">]</span>,
                      <span class="org-rainbow-delimiters-depth-3">[</span>99,99,99,99,99,99,99,99<span class="org-rainbow-delimiters-depth-3">]</span>,
                      <span class="org-rainbow-delimiters-depth-3">[</span>99,99,99,99,99,99,99,99<span class="org-rainbow-delimiters-depth-3">]</span>,
                      <span class="org-rainbow-delimiters-depth-3">[</span>99,99,99,99,99,99,99,99<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>

    <span class="org-keyword">def</span> <span class="org-function-name">forward</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">self</span>, x, channel_type<span class="org-rainbow-delimiters-depth-1">)</span>:
        <span class="org-keyword">assert</span> channel_type <span class="org-keyword">in</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">'lum'</span>, <span class="org-string">'chr'</span><span class="org-rainbow-delimiters-depth-1">)</span>

        <span class="org-keyword">if</span> channel_type <span class="org-operator">==</span> <span class="org-string">'lum'</span>:
            <span class="org-variable-name">Q</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.Q_lum
        <span class="org-keyword">else</span>:
            <span class="org-variable-name">Q</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.Q_chr

        <span class="org-variable-name">out</span> <span class="org-operator">=</span> np.<span class="org-builtin">round</span><span class="org-rainbow-delimiters-depth-1">(</span>x<span class="org-operator">/</span>Q<span class="org-rainbow-delimiters-depth-1">)</span>
        <span class="org-keyword">return</span> out

    <span class="org-keyword">def</span> <span class="org-function-name">backward</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">self</span>, x, channel_type<span class="org-rainbow-delimiters-depth-1">)</span>:
        <span class="org-keyword">assert</span> channel_type <span class="org-keyword">in</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">'lum'</span>, <span class="org-string">'chr'</span><span class="org-rainbow-delimiters-depth-1">)</span>

        <span class="org-keyword">if</span> channel_type <span class="org-operator">==</span> <span class="org-string">'lum'</span>:
            <span class="org-variable-name">Q</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.Q_lum
        <span class="org-keyword">else</span>:
            <span class="org-variable-name">Q</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.Q_chr

        <span class="org-variable-name">out</span> <span class="org-operator">=</span> x<span class="org-operator">*</span>Q
        <span class="org-keyword">return</span> out
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org6b09cfe"><span class="org-keyword">import</span> rawpy
<span class="org-keyword">import</span> cv2
<span class="org-keyword">from</span> PIL <span class="org-keyword">import</span> Image
<span class="org-keyword">import</span> numpy <span class="org-keyword">as</span> np
<span class="org-keyword">from</span> multiprocessing.pool <span class="org-keyword">import</span> Pool
<span class="org-keyword">import</span> os
<span class="org-keyword">import</span> matplotlib.pyplot <span class="org-keyword">as</span> plt
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org0b7a9b1"><span class="org-variable-name">lum_downsample</span> <span class="org-operator">=</span> Downsampling<span class="org-rainbow-delimiters-depth-1">(</span>ratio<span class="org-operator">=</span><span class="org-string">'4:4:4'</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">chr_downsample</span> <span class="org-operator">=</span> Downsampling<span class="org-rainbow-delimiters-depth-1">(</span>ratio<span class="org-operator">=</span><span class="org-string">'4:2:0'</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">image_block</span> <span class="org-operator">=</span> ImageBlock<span class="org-rainbow-delimiters-depth-1">(</span>block_height<span class="org-operator">=</span>8, block_width<span class="org-operator">=</span>8<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">dct2d</span> <span class="org-operator">=</span> DCT2D<span class="org-rainbow-delimiters-depth-1">(</span>norm<span class="org-operator">=</span><span class="org-string">'ortho'</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">quantization</span> <span class="org-operator">=</span> Quantization<span class="org-rainbow-delimiters-depth-1">()</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org5d962d3"><span class="org-variable-name">raw</span> <span class="org-operator">=</span> rawpy.imread<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">'/Users/danielmcguiness/Desktop/DSC05719.ARW'</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Postprocess image array (Bayer filter -&gt; RGB)</span>
<span class="org-variable-name">rgb_img</span> <span class="org-operator">=</span> raw.postprocess<span class="org-rainbow-delimiters-depth-1">()</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Colorspace transform (RGB -&gt; YCrCb)</span>
<span class="org-variable-name">ycc_img</span> <span class="org-operator">=</span> cv2.cvtColor<span class="org-rainbow-delimiters-depth-1">(</span>rgb_img, cv2.COLOR_RGB2YCrCb<span class="org-rainbow-delimiters-depth-1">)</span>

plt.imshow<span class="org-rainbow-delimiters-depth-1">(</span>ycc_img<span class="org-rainbow-delimiters-depth-1">)</span>

cp.store_fig<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"ycrcb"</span>, close<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>

</pre>
</div>


<div id="org1313993" class="figure">
<p><img src="images/Image-Formats/ycrcb.png" alt="ycrcb.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org24b8a5e"><span class="org-variable-name">ycc_img</span> <span class="org-operator">=</span> ycc_img.astype<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-builtin">int</span><span class="org-rainbow-delimiters-depth-1">)</span><span class="org-operator">-</span>128
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="orgc05f8c3"><span class="org-comment-delimiter"># </span><span class="org-comment">Downsampling</span>
<span class="org-variable-name">Y</span> <span class="org-operator">=</span> lum_downsample<span class="org-rainbow-delimiters-depth-1">(</span>ycc_img<span class="org-rainbow-delimiters-depth-2">[</span>:,:,0<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">Cr</span> <span class="org-operator">=</span> chr_downsample<span class="org-rainbow-delimiters-depth-1">(</span>ycc_img<span class="org-rainbow-delimiters-depth-2">[</span>:,:,1<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">Cb</span> <span class="org-operator">=</span> chr_downsample<span class="org-rainbow-delimiters-depth-1">(</span>ycc_img<span class="org-rainbow-delimiters-depth-2">[</span>:,:,2<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-variable-name">ycc_img</span> <span class="org-operator">=</span> np.stack<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>Y, Cr, Cb<span class="org-rainbow-delimiters-depth-2">)</span>, axis<span class="org-operator">=</span>2<span class="org-rainbow-delimiters-depth-1">)</span>

plt.imshow<span class="org-rainbow-delimiters-depth-1">(</span>ycc_img<span class="org-rainbow-delimiters-depth-1">)</span>
cp.store_fig<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"ycrcb-downsampling"</span>, close<span class="org-operator">=</span><span class="org-constant">True</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>


<div id="org1d9dfb8" class="figure">
<p><img src="images/Image-Formats/ycrcb-downsampling.png" alt="ycrcb-downsampling.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org5f06a0a"><span class="org-comment-delimiter"># </span><span class="org-comment">Create 8x8 blocks</span>
<span class="org-variable-name">blocks</span>, <span class="org-variable-name">indices</span> <span class="org-operator">=</span> image_block.forward<span class="org-rainbow-delimiters-depth-1">(</span>ycc_img<span class="org-rainbow-delimiters-depth-1">)</span>

</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="orge81c5e3"><span class="org-keyword">def</span> <span class="org-function-name">process_block</span><span class="org-rainbow-delimiters-depth-1">(</span>block, index<span class="org-rainbow-delimiters-depth-1">)</span>:
    <span class="org-comment-delimiter"># </span><span class="org-comment">DCT</span>
    <span class="org-variable-name">encoded</span> <span class="org-operator">=</span> dct2d.forward<span class="org-rainbow-delimiters-depth-1">(</span>block<span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-keyword">if</span> index<span class="org-rainbow-delimiters-depth-1">[</span>2<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-operator">==</span> 0:
        <span class="org-variable-name">channel_type</span> <span class="org-operator">=</span> <span class="org-string">'lum'</span>
    <span class="org-keyword">else</span>:
        <span class="org-variable-name">channel_type</span> <span class="org-operator">=</span> <span class="org-string">'chr'</span>

    <span class="org-comment-delimiter"># </span><span class="org-comment">Quantization</span>
    <span class="org-variable-name">encoded</span> <span class="org-operator">=</span> quantization.forward<span class="org-rainbow-delimiters-depth-1">(</span>encoded, channel_type<span class="org-rainbow-delimiters-depth-1">)</span>

    <span class="org-comment-delimiter"># </span><span class="org-comment">Dequantization</span>
    <span class="org-variable-name">decoded</span> <span class="org-operator">=</span> quantization.backward<span class="org-rainbow-delimiters-depth-1">(</span>encoded, channel_type<span class="org-rainbow-delimiters-depth-1">)</span>

    <span class="org-comment-delimiter"># </span><span class="org-comment">Reverse DCT</span>
    <span class="org-variable-name">compressed</span> <span class="org-operator">=</span> dct2d.backward<span class="org-rainbow-delimiters-depth-1">(</span>decoded<span class="org-rainbow-delimiters-depth-1">)</span>
    <span class="org-keyword">return</span> compressed

<span class="org-variable-name">compressed</span> <span class="org-operator">=</span> np.array<span class="org-rainbow-delimiters-depth-1">(</span>process_block<span class="org-rainbow-delimiters-depth-2">(</span>blocks, indices<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="orgbe5d726"><span class="org-variable-name">ycc_img_compressed</span> <span class="org-operator">=</span> image_block.backward<span class="org-rainbow-delimiters-depth-1">(</span>compressed, indices<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Rescale</span>
<span class="org-variable-name">ycc_img_compressed</span> <span class="org-operator">=</span> <span class="org-rainbow-delimiters-depth-1">(</span>ycc_img_compressed<span class="org-operator">+</span>128<span class="org-rainbow-delimiters-depth-1">)</span>.astype<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">'uint8'</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Transform back to RGB</span>
<span class="org-variable-name">rgb_img_compressed</span> <span class="org-operator">=</span> cv2.cvtColor<span class="org-rainbow-delimiters-depth-1">(</span>ycc_img_compressed, cv2.COLOR_YCrCb2RGB<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Write to file</span>
Image.fromarray<span class="org-rainbow-delimiters-depth-1">(</span>rgb_img_compressed<span class="org-rainbow-delimiters-depth-1">)</span>.save<span class="org-rainbow-delimiters-depth-1">(</span>os.path.join<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">'images'</span>, <span class="org-string">'result.jpeg'</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Daniel McGuiness</p>
</div>
</body>
</html>
